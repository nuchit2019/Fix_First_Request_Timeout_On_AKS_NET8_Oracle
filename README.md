# How to Fix "First Request Timeout" on AKS (.NET 8 + Oracle + Dapper) 

**Best Practices ‚Äî ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Call ‡πÅ‡∏£‡∏Å Timeout ‡∏ö‡∏ô AKS (.NET + Oracle + Dapper)**

---

## üü¶ ‡∏ö‡∏ó‡∏ô‡∏≥ (Introduction)

‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤ Microservices ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ô‡∏ö‡∏ô **Azure Kubernetes Service (AKS)** ‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Oracle ‡∏ú‡πà‡∏≤‡∏ô .NET WebAPI + Dapper ‡πÄ‡∏£‡∏≤‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏ã‡πâ‡∏≥‡∏ö‡πà‡∏≠‡∏¢‡∏°‡∏≤‡∏Å‡∏Ñ‡∏∑‡∏≠:

> ‚ùó **‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ Traffic ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡∏ô‡∏∂‡πà‡∏á (‡πÄ‡∏ä‡πà‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô) ‡∏Å‡∏≤‡∏£ Call ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏à‡∏∞ Timeout**
> ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£ Deploy / Restart Pod

‡πÅ‡∏°‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á SQL ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å ‡πÅ‡∏•‡∏∞ Performance DB ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÅ‡∏ï‡πà‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏¢‡∏±‡∏á‡πÄ‡∏à‡∏≠ Timeout ‚Äï ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà SQL ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ **Connection Pooling + Network Idle Timeout + Stale Connection** ‡πÉ‡∏ô container/Kubernetes environment

‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏™‡∏£‡∏∏‡∏õ Best Practices ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dev ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ **call ‡πÅ‡∏£‡∏Å Timeout** ‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö:

1. ‚úÖ ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤
2. ‚úÖ ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
3. ‚úÖ ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏Ñ‡πâ‡∏î ‡πÅ‡∏•‡∏∞ connection string)

---

## üü¶ ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (Detail)

---

### ‚úÖ 1. ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (Root Causes)

| ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏                                                              | ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢                                                                                                                   |
| ------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------ |
| **Stale / Broken Connection ‡πÉ‡∏ô Connection Pool**                    | ‡πÅ‡∏≠‡∏õ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô connection ‡∏ô‡∏≤‡∏ô ‚Üí Oracle/Firewall ‡∏õ‡∏¥‡∏î TCP ‡πÅ‡∏ï‡πà Pool ‡∏Ç‡∏≠‡∏á .NET ‡∏¢‡∏±‡∏á‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‚Üí ‡∏´‡∏¢‡∏¥‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß Timeout |
| **Cold Start ‡∏Ç‡∏≠‡∏á Pod ‡∏ö‡∏ô AKS**                                       | ‡∏´‡∏•‡∏±‡∏á Restart/Scale Pod ‡πÉ‡∏´‡∏°‡πà ‚Üí Load assembly, JIT, Dapper mapping, ‡∏™‡∏£‡πâ‡∏≤‡∏á connection pool ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ init                   |
| **‡πÑ‡∏°‡πà‡∏°‡∏µ Min Pool Size**                                             | Pool ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 0 connection ‚Üí Call ‡πÅ‡∏£‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤ Build connection                                                       |
| **‡πÑ‡∏°‡πà‡∏°‡∏µ Validate Connection ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ**                               | ‡πÅ‡∏≠‡∏õ‡∏´‡∏¢‡∏¥‡∏ö connection ‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö                                                                  |
| **Network Idle Timeout ‡∏à‡∏≤‡∏Å Firewall / Load Balancer / NAT Gateway** | Idle TCP connection ‡∏ñ‡∏π‡∏Å Kill                                                                                             |
| **‡πÑ‡∏°‡πà‡∏°‡∏µ Readiness Probe**                                           | Pod ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ü‡∏ü‡∏¥‡∏Å ‡πÅ‡∏ï‡πà Connection DB ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ                                                                          |

---

### ‚úÖ 2. ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö (Impact)

| ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö                             | ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î                                  |
| ----------------------------------- | ------------------------------------------- |
| ‚ùå Call ‡πÅ‡∏£‡∏Å Timeout ‚Üí API Return 500 | ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á error                      |
| ‚ùå Dev ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ú‡∏¥‡∏î‡∏ß‡πà‡∏≤ SQL ‡∏ä‡πâ‡∏≤          | ‡∏ó‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á DB                  |
| ‚ùå ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏¢‡∏≤‡∏Å       | ‡πÑ‡∏°‡πà‡∏°‡∏µ Log ‡∏ó‡∏µ‡πà‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ connection ‡∏Ñ‡πâ‡∏≤‡∏á         |
| ‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á Load ‡πÅ‡∏õ‡∏•‡∏Å‡∏õ‡∏•‡∏≠‡∏°‡∏ö‡∏ô DB          | ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á connection burst ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å timeout |

---

### ‚úÖ 3. ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Best Practices)

---

#### ‚úÖ 3.1 ‡∏õ‡∏£‡∏±‡∏ö Connection String (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å)

> ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ñ‡∏∑‡∏≠: **Warm pool + Validate connection + Kill stale connection**

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á connection string **‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ**

```ini
Pooling=true;
Min Pool Size=2;
Max Pool Size=50;
Incr Pool Size=5;
Decr Pool Size=2;
Connection Lifetime=300;
Validate Connection=true;
Statement Cache Size=50;
Data Source=(DESCRIPTION=(ENABLE=BROKEN)
            (ADDRESS=(PROTOCOL=TCP)(HOST=xxx)(PORT=1521))
            (CONNECT_DATA=(SERVICE_NAME=GISPROD)));
```

| ‡∏Ñ‡∏µ‡∏¢‡πå                       | ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà                                         |
| -------------------------- | ------------------------------------------------- |
| `ENABLE=BROKEN`            | ‡∏ó‡∏≥‡πÉ‡∏´‡πâ driver ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö connection ‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô |
| `Min Pool Size=2`          | ‡∏≠‡∏∏‡πà‡∏ô connection pool ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà start app            |
| `Connection Lifetime=300`  | ‡∏ï‡∏±‡∏î stale connection ‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ                   |
| `Validate Connection=true` | ‡πÄ‡∏ä‡πá‡∏Ñ connection ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡∏•‡∏î Timeout         |

---

#### ‚úÖ 3.2 ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î (.NET + Dapper)

> ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡πá‡∏ö connection ‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô Singleton / Scoped

```csharp
await using var conn = new OracleConnection(ConnectionString);
await conn.OpenAsync(cancellationToken);

var result = await conn.QueryAsync<T>(sql, param);
```

---

#### ‚úÖ 3.3 ‡πÄ‡∏û‡∏¥‡πà‡∏° Readiness Probe (AKS)

> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Pod ‡∏£‡∏±‡∏ö Traffic **‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô DB ‡∏û‡∏£‡πâ‡∏≠‡∏°**

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô `deployment.yaml`

```yaml
readinessProbe:
  httpGet:
    path: /health/db
    port: 8080
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 3
  failureThreshold: 3
```

‡∏™‡∏£‡πâ‡∏≤‡∏á endpoint `/health/db` ‡πÉ‡∏´‡πâ‡∏¢‡∏¥‡∏á `SELECT 1 FROM DUAL`

---

#### ‚úÖ 3.4 Require DBA Config

‡πÉ‡∏´‡πâ DBA ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô `sqlnet.ora` ‡∏Ç‡∏≠‡∏á Oracle Server:

```
SQLNET.EXPIRE_TIME = 5
```

‡∏ä‡πà‡∏ß‡∏¢ detect dead TCP connection ‚Üí ‡∏ó‡∏≥‡πÉ‡∏´‡πâ connection pool ‡πÑ‡∏°‡πà‡∏Ñ‡πâ‡∏≤‡∏á

---

### ‚úÖ 3.5 Monitoring & Logging

‡∏Ñ‡∏ß‡∏£ Log

| Metric                                  | ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏∞‡πÑ‡∏£                     |
| --------------------------------------- | ---------------------------------- |
| ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Connection (`OpenAsync()`)     | ‡∏ä‡πâ‡∏≤‡πÄ‡∏û‡∏£‡∏≤‡∏∞ network / connection pool |
| ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Connection Active                 | ‡πÉ‡∏ä‡πâ monitor Idle/High Load         |
| Error ORA-12570 / ORA-03113 / ORA-12170 | ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏µ broken connection         |

---

## üü¶ ‡∏ö‡∏ó‡∏™‡∏£‡∏∏‡∏õ (Conclusion)

| ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡πâ‡∏ô ‡πÜ                                                                                                |
| --------------------------------------------------------------------------------------------------------- |
| ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Timeout ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å SQL ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å **Stale Connection + Cold Pool + Idle Timeout ‡∏ö‡∏ô AKS** |
| ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡∏Ñ‡∏∑‡∏≠ **Warm pool + Validate connection + Readiness Probe + ‡∏•‡∏ö connection ‡∏ó‡∏µ‡πà stale**              |
| ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ ‡∏à‡∏∞‡∏•‡∏î timeout ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏à‡∏≤‡∏Å **10‚Äì30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚Üí ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ < 500ms**                        |

---

### ‚úÖ Check List ‡∏Å‡πà‡∏≠‡∏ô Deploy

* [ ] ‡∏°‡∏µ `ENABLE=BROKEN` + `Validate Connection=true`
* [ ] ‡∏ï‡∏±‡πâ‡∏á `Min Pool Size >= 2`
* [ ] ‡πÉ‡∏ä‡πâ `Connection Lifetime=300`
* [ ] readiness probe ‡∏¢‡∏¥‡∏á SQL
* [ ] ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö connection ‡πÄ‡∏õ‡πá‡∏ô singleton/scoped
* [ ] ‡∏°‡∏µ logging ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î connection

---

‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ version **‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Slide / PowerPoint / Wiki PDF** ‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á Diagram Sequence Flow ‡πÅ‡∏•‡∏∞ Architecture ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ üôå
